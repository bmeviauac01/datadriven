
<!DOCTYPE html>

<html class="no-js" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<meta content="István Albert, Tibor Tóth" name="author"/>
<link href="https://bmeviauac01.github.io/datadriven/en/lecture-notes/mssql/server-side-programming/" rel="canonical"/>
<link href="../sql/" rel="prev"/>
<link href="../../adonet/" rel="next"/>
<link href="../../../img/favicon.ico" rel="icon"/>
<meta content="mkdocs-1.4.2, mkdocs-material-9.0.9" name="generator"/>
<title>Microsoft SQL Server programming - BMEVIAUAC01 Data-driven systems</title>
<link href="../../../assets/stylesheets/main.0d440cfe.min.css" rel="stylesheet"/>
<link href="../../../assets/stylesheets/palette.2505c338.min.css" rel="stylesheet"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback" rel="stylesheet"/>
<style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
<link href="../../../css/timeago.css" rel="stylesheet"/>
<link href="../../../extra-material-theme.css" rel="stylesheet"/>
<script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
<link href="../../../assets/stylesheets/glightbox.min.css" rel="stylesheet"/><style>
            html.glightbox-open { overflow: initial; height: 100%; }
            .gslide-title { margin-top: 0px; user-select: text; }
            .gslide-desc { color: #666; user-select: text; }
            .gslide-image img { background: white; }
            
                .gscrollbar-fixer { padding-right: 15px; }
                .gdesc-inner { font-size: 0.75rem; }
                body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color);}
                body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color);}
                body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color);}
                </style><script src="../../../assets/javascripts/glightbox.min.js"></script></head>
<body data-md-color-accent="red" data-md-color-primary="aut" data-md-color-scheme="aut" dir="ltr">
<script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
<a class="md-skip" href="#microsoft-sql-server-programming">
          Skip to content
        </a>
</div>
<div data-md-component="announce">
</div>
<header class="md-header" data-md-component="header">
<nav aria-label="Header" class="md-header__inner md-grid">
<a aria-label="BMEVIAUAC01 Data-driven systems" class="md-header__button md-logo" data-md-component="logo" href="../../.." title="BMEVIAUAC01 Data-driven systems">
<img alt="logo" src="../../../img/logo-bme-aut.png"/>
</a>
<label class="md-header__button md-icon" for="__drawer">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"></path></svg>
</label>
<div class="md-header__title" data-md-component="header-title">
<div class="md-header__ellipsis">
<div class="md-header__topic">
<span class="md-ellipsis">
            BMEVIAUAC01 Data-driven systems
          </span>
</div>
<div class="md-header__topic" data-md-component="header-topic">
<span class="md-ellipsis">
            
              Microsoft SQL Server programming
            
          </span>
</div>
</div>
</div>
<form class="md-header__option" data-md-component="palette">
<input aria-label="Váltás sötét témára" class="md-option" data-md-color-accent="red" data-md-color-media="(prefers-color-scheme: light)" data-md-color-primary="aut" data-md-color-scheme="aut" id="__palette_1" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_2" hidden="" title="Váltás sötét témára">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 2a7 7 0 0 1 7 7c0 2.38-1.19 4.47-3 5.74V17a1 1 0 0 1-1 1H9a1 1 0 0 1-1-1v-2.26C6.19 13.47 5 11.38 5 9a7 7 0 0 1 7-7M9 21v-1h6v1a1 1 0 0 1-1 1h-4a1 1 0 0 1-1-1m3-17a5 5 0 0 0-5 5c0 2.05 1.23 3.81 3 4.58V16h4v-2.42c1.77-.77 3-2.53 3-4.58a5 5 0 0 0-5-5Z"></path></svg>
</label>
<input aria-label="Váltás világos témára" class="md-option" data-md-color-accent="" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-primary="red" data-md-color-scheme="slate" id="__palette_2" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_1" hidden="" title="Váltás világos témára">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 2a7 7 0 0 0-7 7c0 2.38 1.19 4.47 3 5.74V17a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1v-2.26c1.81-1.27 3-3.36 3-5.74a7 7 0 0 0-7-7M9 21a1 1 0 0 0 1 1h4a1 1 0 0 0 1-1v-1H9v1Z"></path></svg>
</label>
</form>
<div class="md-header__option">
<div class="md-select">
<button aria-label="Select language" class="md-header__button md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="m12.87 15.07-2.54-2.51.03-.03A17.52 17.52 0 0 0 14.07 6H17V4h-7V2H8v2H1v2h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04M18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12m-2.62 7 1.62-4.33L19.12 17h-3.24Z"></path></svg>
</button>
<div class="md-select__inner">
<ul class="md-select__list">
<li class="md-select__item">
<a class="md-select__link" href="https://bmeviauac01.github.io/datadriven/en/" hreflang="en">
                    English
                  </a>
</li>
<li class="md-select__item">
<a class="md-select__link" href="https://bmeviauac01.github.io/datadriven/hu/" hreflang="hu">
                    Magyar
                  </a>
</li>
</ul>
</div>
</div>
</div>
<label class="md-header__button md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"></path></svg>
</label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input aria-label="Search" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" name="query" placeholder="Search" required="" spellcheck="false" type="text"/>
<label class="md-search__icon md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"></path></svg>
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"></path></svg>
</label>
<nav aria-label="Search" class="md-search__options">
<button aria-label="Clear" class="md-search__icon md-icon" tabindex="-1" title="Clear" type="reset">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"></path></svg>
</button>
</nav>
<div class="md-search__suggest" data-md-component="search-suggest"></div>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix="">
<div class="md-search-result" data-md-component="search-result">
<div class="md-search-result__meta">
            Initializing search
          </div>
<ol class="md-search-result__list" role="presentation"></ol>
</div>
</div>
</div>
</div>
</div>
<div class="md-header__source">
<a class="md-source" data-md-component="source" href="https://github.com/bmeviauac01/datadriven" title="Go to repository">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 496 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg>
</div>
<div class="md-source__repository">
    bmeviauac01/datadriven
  </div>
</a>
</div>
</nav>
</header>
<div class="md-container" data-md-component="container">
<nav aria-label="Tabs" class="md-tabs" data-md-component="tabs">
<div class="md-tabs__inner md-grid">
<ul class="md-tabs__list">
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../..">
      Data-driven systems
    </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../db/">
        Database
      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link md-tabs__link--active" href="../../architecture/">
        Lecture notes
      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../seminar/transactions/">
        Seminars
      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../homework/">
        Homework
      </a>
</li>
</ul>
</div>
</nav>
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Navigation" class="md-nav md-nav--primary md-nav--lifted" data-md-level="0">
<label class="md-nav__title" for="__drawer">
<a aria-label="BMEVIAUAC01 Data-driven systems" class="md-nav__button md-logo" data-md-component="logo" href="../../.." title="BMEVIAUAC01 Data-driven systems">
<img alt="logo" src="../../../img/logo-bme-aut.png"/>
</a>
    BMEVIAUAC01 Data-driven systems
  </label>
<div class="md-nav__source">
<a class="md-source" data-md-component="source" href="https://github.com/bmeviauac01/datadriven" title="Go to repository">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 496 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg>
</div>
<div class="md-source__repository">
    bmeviauac01/datadriven
  </div>
</a>
</div>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../..">
        Data-driven systems
      </a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_2" type="checkbox"/>
<label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
          Database
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_2_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_2">
<span class="md-nav__icon md-icon"></span>
          Database
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../db/">
        Sample database scheme
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../db/mssql/">
        Using Microsoft SQL Server
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../db/mongodb/">
        Using MongoDB
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="https://raw.githubusercontent.com/bmeviauac01/datadriven/master/overrides/db/mssql.sql">
        Sample database: mssql.sql
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="https://raw.githubusercontent.com/bmeviauac01/datadriven/master/overrides/db/mongo.js">
        Sample database: mongo.js
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--active md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" id="__nav_3" type="checkbox"/>
<label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
          Lecture notes
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="true" aria-labelledby="__nav_3_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_3">
<span class="md-nav__icon md-icon"></span>
          Lecture notes
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../architecture/">
        Data-driven systems and the three- or multi-tier architecture
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../transactions/">
        Transactions in databases
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../sql/">
        SQL language, MSSQL platform-specific SQL
      </a>
</li>
<li class="md-nav__item md-nav__item--active">
<input class="md-nav__toggle md-toggle" id="__toc" type="checkbox"/>
<label class="md-nav__link md-nav__link--active" for="__toc">
          Microsoft SQL Server programming
          <span class="md-nav__icon md-icon"></span>
</label>
<a class="md-nav__link md-nav__link--active" href="./">
        Microsoft SQL Server programming
      </a>
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#server-side-programming">
    Server-side programming
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#basics-of-the-t-sql-language">
    Basics of the T-SQL language
  </a>
<nav aria-label="Basics of the T-SQL language" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#variables">
    Variables
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#instruction-blocks-and-control-structures">
    Instruction blocks and control structures
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#built-in-functions">
    Built-in functions
  </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#cursors">
    Cursors
  </a>
<nav aria-label="Cursors" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#declaration-and-opening">
    Declaration and opening
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#advancing-the-cursor">
    Advancing the cursor
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#example">
    Example
  </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#stored-procedures-and-functions">
    Stored procedures and functions
  </a>
<nav aria-label="Stored procedures and functions" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#procedures">
    Procedures
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#scalar-functions">
    Scalar functions
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#table-functions">
    Table functions
  </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#error-handling">
    Error handling
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#triggers">
    Triggers
  </a>
<nav aria-label="Triggers" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#dml-triggers">
    DML triggers
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#instead-of-triggers">
    Instead of triggers
  </a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../adonet/">
        ADO.NET data access
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../linq/">
        LINQ: Language Integrated Query
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../ef/">
        Defining relationships in Entity Framework
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../mongodb/">
        MongoDB basics, operations, and the MongoDB .NET Driver
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../di/">
        Dependency Injection ASP.NET Core environment
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../async/">
        Asynchronous queries and DTOs (sample WebAPI application)
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="https://github.com/bmeviauac01/rest-webapi-sample">
        REST and WebAPI sample app (GitHub)
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="https://github.com/bmeviauac01/todoapi-di-sample">
        ASP.NET Core DI sample app (GitHub)
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="https://github.com/bmeviauac01/threelayered-aspnetcore-sample">
        Sample three-tier webapp (GitHub)
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_4" type="checkbox"/>
<label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
          Seminars
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_4_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_4">
<span class="md-nav__icon md-icon"></span>
          Seminars
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../seminar/transactions/">
        Transactions
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../seminar/mssql/">
        Microsoft SQL Server programming
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../seminar/ef/">
        Entity Framework
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../seminar/mongodb/">
        MongoDB
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../seminar/jpa/">
        JPA &amp; Spring Data
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../seminar/rest/">
        REST API &amp; ASP.NET Web API
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_5" type="checkbox"/>
<label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
          Homework
          <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_5_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_5">
<span class="md-nav__icon md-icon"></span>
          Homework
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../homework/">
        Optional homework
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../homework/mssql/">
        Exercise: MSSQL server-side programming
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../homework/adonet/">
        Exercise: ADO.NET data access
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../homework/ef/">
        Exercise: Entity Framework
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../homework/mongodb/">
        Exercise: MongoDB
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../homework/rest/">
        Exercise: REST API and Web API
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../homework/GitHub/">
        Submitting your work (GitHub)
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../homework/GitHub-Actions/">
        Using GitHub Actions
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../homework/VisualStudio/">
        Install Visual Studio &amp; .NET SDK
      </a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#server-side-programming">
    Server-side programming
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#basics-of-the-t-sql-language">
    Basics of the T-SQL language
  </a>
<nav aria-label="Basics of the T-SQL language" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#variables">
    Variables
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#instruction-blocks-and-control-structures">
    Instruction blocks and control structures
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#built-in-functions">
    Built-in functions
  </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#cursors">
    Cursors
  </a>
<nav aria-label="Cursors" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#declaration-and-opening">
    Declaration and opening
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#advancing-the-cursor">
    Advancing the cursor
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#example">
    Example
  </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#stored-procedures-and-functions">
    Stored procedures and functions
  </a>
<nav aria-label="Stored procedures and functions" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#procedures">
    Procedures
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#scalar-functions">
    Scalar functions
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#table-functions">
    Table functions
  </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#error-handling">
    Error handling
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#triggers">
    Triggers
  </a>
<nav aria-label="Triggers" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#dml-triggers">
    DML triggers
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#instead-of-triggers">
    Instead of triggers
  </a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-content" data-md-component="content">
<article class="md-content__inner md-typeset">
<a class="md-content__button md-icon" href="https://github.com/bmeviauac01/datadriven/blob/master/docs/hu/lecture-notes/mssql/server-side-programming.md" title="Edit this page">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M10 20H6V4h7v5h5v3.1l2-2V8l-6-6H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h4v-2m10.2-7c.1 0 .3.1.4.2l1.3 1.3c.2.2.2.6 0 .8l-1 1-2.1-2.1 1-1c.1-.1.2-.2.4-.2m0 3.9L14.1 23H12v-2.1l6.1-6.1 2.1 2.1Z"></path></svg>
</a>
<h1 id="microsoft-sql-server-programming">Microsoft SQL Server programming<a class="headerlink" href="#microsoft-sql-server-programming" title="Permanent link">¶</a></h1>
<p>The language of the Microsoft SQL Server platform is <strong>T-SQL</strong>. The T-SQL language is platform-specific, meaning the language can only be used in MSSQL server - although other platforms have similar languages. The T-SQL language and the <strong>database server-side programming tools</strong> it supports extend the originally declarative SQL language with imperative tools such as variables, branches, procedures, and additional tools such as triggers and cursors.</p>
<h2 id="server-side-programming">Server-side programming<a class="headerlink" href="#server-side-programming" title="Permanent link">¶</a></h2>
<div class="admonition abstract">
<p class="admonition-title">Server-side programming</p>
<p>By server-side or database server-side programming, we mean that we execute not only commands to query and modify data in the database, but also carry out business logic inside the database.</p>
</div>
<p>To understand <em>when</em> it is worthwhile to use server-side programming tools, it is first important to understand <em>why</em> we would consider writing business logic in the database at all.</p>
<div class="admonition question">
<p class="admonition-title">Why would we want to implement business logic tasks in the database?</p>
<p>In a layered architecture, the lower layer provides services to the layer above it. So the upper layer "can't get around" the layer below; the operations have to go through the lower layer. But when you consider C#/Java/C++/ etc. code, we may not be able to guarantee such rules in the codebase. If we implement a complex set of rules and logic in a C# class, for example, it is difficult to guarantee that this class cannot be "bypassed."</p>
<p>However, if the logic is in the database, it cannot be bypassed or circumvented. This will also be due to the fact that server-side programming gives us tools that ensure the execution of certain logic under all circumstances (see triggers later).</p>
</div>
<p>There are advantages and disadvantages to server-side programming. When considering the implementation of a functionality, in addition to knowing the layered architecture, we also need to look at what the technologies allow and which of the possible alternatives has the most benefits.</p>
<p>If we implement business functionality in the database, we ensure the following <strong>benefits</strong>.</p>
<ul>
<li>
<p>The responsibility of the database for managing consistency becomes even more evident. The relational model places great emphasis on consistency, but not all business consistency rules can be described directly in the relational model. Just think of the example of the Neptune system, where courses have an enrollment limit. This is a business rule, and if we break it, our data is inconsistent in the business sense. If the database is responsible for complying with this rule, we can ensure that the data is always consistent.</p>
</li>
<li>
<p>We can reduce data traffic going out of the database. We often query data to display it to the user, which we cannot reduce. But if we query data only to make a decision based on it in the business logic layer, it is possible to avoid transferring the data between the database and the business logic if we bring the logic into the database instead. This is also more secure because no data is sent over the network unnecessarily (where sensitive data may be intercepted or outputted into error messages and log files by accident).</p>
</li>
<li>
<p>The logic written in the database server can also be thought of as an interface that hides the details of data access and modification from the user (here: data access layer or business logic layer). On the one hand, this provides us with a level of abstraction, and on the other hand, it can aid parallel, faster development. While one development team builds the logic in the database, another team can write the application on top of it because the interface is defined earlier. Fixing errors is also more straightforward when the error is in the database. In this case, it is enough to fix the code in the database. Any system built on top of it will work correctly right away (unlike fixing a bug in Java code, because then a new version of the Java application has to be released and installed too).</p>
</li>
</ul>
<p>Of course, there are <strong>disadvantages</strong> to server-side programming.</p>
<ul>
<li>
<p>The language we use is platform-dependent. We cannot transfer solutions from one database system to another. Moreover, programming knowledge itself is not easily transferable. A C++ programmer can code in C# more quickly than if he did not have such knowledge. But this is not true for server-side programming. One platform does not support the same tools as the other. The syntax of the languages also differs significantly. Database server-side programming requires an entirely new approach and different techniques.</p>
</li>
<li>
<p>The load of the database server is increased. If a server performs more tasks, it will require more resources. Databases are critical points of data-driven systems, primarily since classical relational databases do not support horizontal scaling too well (load balancing between multiple servers). If the database server is responsible for more tasks, it can quickly become the bottleneck.</p>
</li>
<li>
<p>These techniques are no longer evolving. We might even call them outdated used only in legacy applications. This server-side world is less common nowadays in software development projects.</p>
</li>
</ul>
<h2 id="basics-of-the-t-sql-language">Basics of the T-SQL language<a class="headerlink" href="#basics-of-the-t-sql-language" title="Permanent link">¶</a></h2>
<p>The T-SQL language is the language of Microsoft SQL Server, which, in addition to the standard SQL statements, allows you to:</p>
<ul>
<li>use variables,</li>
<li>write branches and cycles,</li>
<li>create stored procedures ("methods"),</li>
<li>use cursors (iterators),</li>
<li>define triggers (event-handling procedures),</li>
<li>and much more.</li>
</ul>
<p>Let’s look at the syntax of the language through examples. See the <a href="https://docs.microsoft.com/en-us/sql/t-sql/language-reference">official documentation</a> for the detailed syntax.</p>
<div class="admonition note">
<p>The following examples can be executed on the <a href="../../../db/">sample database</a>.</p>
</div>
<h3 id="variables">Variables<a class="headerlink" href="#variables" title="Permanent link">¶</a></h3>
<p>Variables must be declared before use. By convention, variable names begin with <code>@</code>. Uninitialized variables are all <code>NULL</code>.</p>
<div class="highlight"><pre><span></span><code><span class="k">DECLARE</span><span class="w"> </span><span class="o">@</span><span class="n">num</span><span class="w"> </span><span class="nb">int</span>

<span class="k">SELECT</span><span class="w"> </span><span class="o">@</span><span class="n">num</span>
<span class="c1">-- NULL</span>
</code></pre></div>
<p>Value assignment is possible with the <code>SET</code> statement or directly in the declaration:</p>
<div class="highlight"><pre><span></span><code><span class="k">DECLARE</span><span class="w"> </span><span class="o">@</span><span class="n">num</span><span class="w"> </span><span class="nb">int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span>

<span class="k">SELECT</span><span class="w"> </span><span class="o">@</span><span class="n">num</span>
<span class="c1">-- 5</span>

<span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="n">num</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span>

<span class="k">SELECT</span><span class="w"> </span><span class="o">@</span><span class="n">num</span>
<span class="c1">-- 3</span>
</code></pre></div>
<p>The scope of the variable is not bound to the instruction block (between <code>BEGIN-END</code>). The variable is available within the so-called <em>batch</em> or stored procedure:</p>
<div class="highlight"><pre><span></span><code><span class="k">BEGIN</span>
<span class="w">  </span><span class="k">DECLARE</span><span class="w"> </span><span class="o">@</span><span class="n">num</span><span class="w"> </span><span class="nb">int</span>
<span class="w">  </span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="n">num</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span>
<span class="k">END</span>

<span class="k">SELECT</span><span class="w"> </span><span class="o">@</span><span class="n">num</span>
<span class="c1">-- This works, the variable is also available outside the instruction block.</span>
<span class="c1">-- 3</span>

<span class="k">GO</span><span class="w"> </span><span class="c1">-- starts a new batch</span>

<span class="k">SELECT</span><span class="w"> </span><span class="o">@</span><span class="n">num</span>
<span class="c1">-- Error: Must declare the scalar variable "@num".</span>
</code></pre></div>
<p>You can also assign value to a variable via a query:</p>
<div class="highlight"><pre><span></span><code><span class="k">DECLARE</span><span class="w"> </span><span class="o">@</span><span class="n">name</span><span class="w"> </span><span class="n">nvarchar</span><span class="w"> </span><span class="p">(</span><span class="k">max</span><span class="p">)</span>

<span class="k">SELECT</span><span class="w"> </span><span class="o">@</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Name</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">Customer</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">ID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span>
</code></pre></div>
<p>If the query returns more than one row, the <em>last</em> value remains in the variable:</p>
<div class="highlight"><pre><span></span><code><span class="k">DECLARE</span><span class="w"> </span><span class="o">@</span><span class="n">name</span><span class="w"> </span><span class="n">nvarchar</span><span class="w"> </span><span class="p">(</span><span class="k">max</span><span class="p">)</span>

<span class="k">SELECT</span><span class="w"> </span><span class="o">@</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Name</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">Customer</span>
<span class="c1">-- there are multiple  matching rows</span>
<span class="c1">-- the last result of SELECT is stored in the variable</span>
</code></pre></div>
<p>If the query does not yield any result, the value of the variable does not change:</p>
<div class="highlight"><pre><span></span><code><span class="k">DECLARE</span><span class="w"> </span><span class="o">@</span><span class="n">name</span><span class="w"> </span><span class="n">nvarchar</span><span class="w"> </span><span class="p">(</span><span class="k">max</span><span class="p">)</span>
<span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'aaa'</span>

<span class="k">SELECT</span><span class="w"> </span><span class="o">@</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Name</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">Customer</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">ID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">99999999</span>
<span class="c1">-- no matching row</span>

<span class="k">SELECT</span><span class="w"> </span><span class="o">@</span><span class="n">name</span>
<span class="c1">-- aaa</span>
</code></pre></div>
<h3 id="instruction-blocks-and-control-structures">Instruction blocks and control structures<a class="headerlink" href="#instruction-blocks-and-control-structures" title="Permanent link">¶</a></h3>
<p>An instruction block is written between <code>BEGIN-END</code> commands:</p>
<div class="highlight"><pre><span></span><code><span class="k">BEGIN</span>
<span class="w">  </span><span class="k">DECLARE</span><span class="w"> </span><span class="o">@</span><span class="n">num</span><span class="w"> </span><span class="nb">int</span>
<span class="w">  </span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="n">num</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span>
<span class="k">END</span>
</code></pre></div>
<p>Branching is possible by using the <code>IF-ELSE</code> structure:</p>
<div class="highlight"><pre><span></span><code><span class="k">DECLARE</span><span class="w"> </span><span class="o">@</span><span class="n">name</span><span class="w"> </span><span class="n">nvarchar</span><span class="w"> </span><span class="p">(</span><span class="k">max</span><span class="p">)</span>

<span class="k">SELECT</span><span class="w"> </span><span class="o">@</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Name</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">Customer</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">ID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">123</span>

<span class="k">IF</span><span class="w"> </span><span class="o">@</span><span class="n">name</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="c1">-- If the user exists</span>
<span class="k">BEGIN</span>
<span class="w">  </span><span class="n">PRINT</span><span class="w"> </span><span class="s1">'Updating email'</span>
<span class="w">  </span><span class="k">UPDATE</span><span class="w"> </span><span class="n">Customer</span>
<span class="w">    </span><span class="k">SET</span><span class="w"> </span><span class="n">Email</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'agh*******@gmail.com'</span>
<span class="w">    </span><span class="k">WHERE</span><span class="w"> </span><span class="n">ID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">123</span>
<span class="k">END</span>
<span class="k">ELSE</span>
<span class="k">BEGIN</span>
<span class="w">  </span><span class="n">PRINT</span><span class="w"> </span><span class="s1">'No such customer'</span>
<span class="k">END</span>
</code></pre></div>
<p>We use the <code>WHILE</code> condition and a <code>BEGIN-END</code> statement block for looping:</p>
<div class="highlight"><pre><span></span><code><span class="c1">-- Generate at least 1000 products (e.g., for testing)</span>
<span class="n">WHILE</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="k">COUNT</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">Product</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">1000</span>
<span class="k">BEGIN</span>
<span class="w">    </span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">Product</span><span class="w"> </span><span class="p">(</span><span class="n">Name</span><span class="p">,</span><span class="w"> </span><span class="n">Price</span><span class="p">,</span><span class="w"> </span><span class="n">Stock</span><span class="p">,</span><span class="w"> </span><span class="n">VATID</span><span class="p">,</span><span class="w"> </span><span class="n">CategoryID</span><span class="p">)</span>
<span class="w">    </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="s1">'Abc'</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">13</span><span class="p">)</span>
<span class="k">END</span>
</code></pre></div>
<h3 id="built-in-functions">Built-in functions<a class="headerlink" href="#built-in-functions" title="Permanent link">¶</a></h3>
<p>There are numerous <a href="https://docs.microsoft.com/en-us/sql/t-sql/functions/functions">built-in functions</a> are available in T-SQL. Below are a few examples.</p>
<div class="admonition note">
<p>In the following examples, the results of the functions are queried with <code>select</code>. This is for the sole purpose of seeing the result. A function can be used anywhere in the language where a scalar value can be used.</p>
</div>
<p>String functions:</p>
<div class="highlight"><pre><span></span><code><span class="c1">-- Concatenation</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">CONCAT</span><span class="p">(</span><span class="s1">'Happy '</span><span class="p">,</span><span class="w"> </span><span class="s1">'Birthday!'</span><span class="p">)</span>
<span class="c1">-- Happy Birthday!</span>

<span class="c1">-- N characters from the left</span>
<span class="k">SELECT</span><span class="w"> </span><span class="k">LEFT</span><span class="p">(</span><span class="s1">'ABCDEF'</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span>
<span class="c1">-- AB</span>

<span class="c1">-- Text length</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">LEN</span><span class="p">(</span><span class="s1">'ABCDEF'</span><span class="p">)</span>
<span class="c1">-- 6</span>

<span class="c1">-- Substring replacement</span>
<span class="k">SELECT</span><span class="w"> </span><span class="k">REPLACE</span><span class="p">(</span><span class="s1">'Happy Birthday!'</span><span class="p">,</span><span class="w"> </span><span class="s1">'day'</span><span class="p">,</span><span class="w"> </span><span class="s1">'month'</span><span class="p">)</span>
<span class="c1">-- Happy Birthmonth!</span>

<span class="c1">-- Lowercase conversion</span>
<span class="k">SELECT</span><span class="w"> </span><span class="k">LOWER</span><span class="p">(</span><span class="s1">'ABCDEF'</span><span class="p">)</span>
<span class="c1">-- abcdef</span>
</code></pre></div>
<p>Manage dates:</p>
<div class="highlight"><pre><span></span><code><span class="c1">-- Current date and time</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">GETDATE</span><span class="p">()</span>
<span class="c1">-- 2021-09-28 10: 43: 59.120</span>

<span class="c1">-- Date's year component</span>
<span class="k">SELECT</span><span class="w"> </span><span class="k">YEAR</span><span class="p">(</span><span class="n">GETDATE</span><span class="w"> </span><span class="p">())</span>
<span class="c1">-- 2021</span>

<span class="c1">-- Specific component of the date</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">DATEPART</span><span class="p">(</span><span class="k">day</span><span class="p">,</span><span class="w"> </span><span class="s1">'12 / 20/2021 '</span><span class="p">)</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">DATEPART</span><span class="p">(</span><span class="k">month</span><span class="p">,</span><span class="w"> </span><span class="s1">'12 / 20/2021 '</span><span class="p">)</span>
<span class="c1">-- 20</span>
<span class="c1">-- 12</span>

<span class="c1">-- Difference between dates measured in a given unit (here: day)</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">DATEDIFF</span><span class="p">(</span><span class="k">day</span><span class="p">,</span><span class="w"> </span><span class="s1">'2021-09-28 12:10:09'</span><span class="p">,</span><span class="w"> </span><span class="s1">'2021-11-04 13:45:09'</span><span class="p">)</span>
<span class="c1">-- 37</span>
</code></pre></div>
<p>Data type conversion:</p>
<div class="highlight"><pre><span></span><code><span class="k">SELECT</span><span class="w"> </span><span class="k">CAST</span><span class="p">(</span><span class="s1">'12 '</span><span class="k">as</span><span class="w"> </span><span class="nb">int</span><span class="p">)</span>
<span class="c1">-- 12</span>

<span class="k">SELECT</span><span class="w"> </span><span class="k">CONVERT</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span><span class="w"> </span><span class="s1">'12'</span><span class="p">)</span>
<span class="c1">-- 12</span>

<span class="k">SELECT</span><span class="w"> </span><span class="k">CONVERT</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span><span class="w"> </span><span class="s1">'aa'</span><span class="p">)</span>
<span class="c1">-- Error: Conversion failed when converting the varchar value 'aa' to data type int.</span>

<span class="k">SELECT</span><span class="w"> </span><span class="n">TRY_CONVERT</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span><span class="w"> </span><span class="s1">'aa'</span><span class="p">)</span>
<span class="c1">-- NULL</span>
</code></pre></div>
<p><code>ISNULL</code>: result is the first argument if it is not null, otherwise the second argument (which can be null).</p>
<div class="highlight"><pre><span></span><code><span class="k">DECLARE</span><span class="w"> </span><span class="o">@</span><span class="n">a</span><span class="w"> </span><span class="nb">int</span>
<span class="k">DECLARE</span><span class="w"> </span><span class="o">@</span><span class="n">b</span><span class="w"> </span><span class="nb">int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span>
<span class="k">SELECT</span><span class="w"> </span><span class="k">ISNULL</span><span class="p">(</span><span class="o">@</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">b</span><span class="p">)</span>
<span class="c1">-- 5</span>
</code></pre></div>
<div class="admonition important">
<p>Not to be confused with the <code>is null</code> condition, e.g., <code>UPDATE Product SET Price = 111 WHERE Price is null</code></p>
</div>
<h2 id="cursors">Cursors<a class="headerlink" href="#cursors" title="Permanent link">¶</a></h2>
<p>A cursor is an iterator used to scroll through a set of records item by item. We use it when a query returns multiple items, and we want to process them individually.</p>
<p>Using a cursor consists of the following steps:</p>
<ol>
<li>The cursor must be declared and then opened.</li>
<li>The iteration takes place in a cycle.</li>
<li>The cursor is closed and released.</li>
</ol>
<h3 id="declaration-and-opening">Declaration and opening<a class="headerlink" href="#declaration-and-opening" title="Permanent link">¶</a></h3>
<p>A cursor is created with the <code>DECLARE</code> statement. We also provide the query yielding the results in the declaration. The full syntax is:</p>
<div class="highlight"><pre><span></span><code><span class="k">DECLARE</span><span class="w"> </span><span class="k">cursor</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="k">CURSOR</span>
<span class="w">  </span><span class="p">[</span><span class="n">FORWARD_ONLY</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">SCROLL</span><span class="p">]</span>
<span class="w">  </span><span class="p">[</span><span class="k">STATIC</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">KEYSET</span><span class="w"> </span><span class="k">DYNAMIC</span><span class="w"> </span><span class="n">FAST_FORWARD</span><span class="p">]</span>
<span class="w">  </span><span class="p">[</span><span class="n">READ_ONLY</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">SCROLL_LOCKS</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">OPTIMISTIC</span><span class="p">]</span>
<span class="k">FOR</span><span class="w"> </span><span class="n">query</span>
<span class="p">[</span><span class="k">FOR</span><span class="w"> </span><span class="k">UPDATE</span><span class="w"> </span><span class="p">[</span><span class="k">OF</span><span class="w"> </span><span class="k">column</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="p">[,</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="n">n</span><span class="p">]]]</span>
</code></pre></div>
<p>The meaning of optional flags in the declaration are (for more details, see the <a href="https://docs.microsoft.com/en-us/sql/t-sql/language-elements/declare-cursor-transact-sql">documentation</a>):</p>
<ul>
<li><code>FORWARD_ONLY</code>: only <code>FETCH NEXT</code> is possible</li>
<li><code>SCROLL</code>: you are free to move forward and backward in the cursor</li>
<li><code>STATIC</code>: works from a copy: the results are snapshotted when opening the cursor</li>
<li><code>KEYSET</code>: the database state at opening the cursor yields the row ids and their order, but the contents of the records are queried when fetching them</li>
<li><code>DYNAMIC</code>: each fetch gets up to date data; allows access to changes of competing transactions</li>
<li><code>READ_ONLY</code>: the contents of the cursor cannot be updated</li>
<li><code>SCROLL_LOCKS</code>: fetching locks the rows, thus guaranteeing that any subsequent <code>update</code> or <code>delete</code> statement is successful</li>
<li><code>OPTIMISTIC</code>: does not lock, uses optimistic concurrency management (to check for any changes between the time of <code>FETCH</code> and subsequent <code>update</code>)</li>
<li><code>FOR UPDATE</code>: list of columns that can be updated</li>
</ul>
<p>The declaration is not enough to use use the cursor; it must be opened with the <code>OPEN</code> command. The pair of <code>OPEN</code> is the <code>CLOSE</code> command ending the use of the cursor. After closing, the cursor can be reopened, so we need to indicate when we no longer use the cursor; this is the <code>DEALLOCATE</code> command. (Typically, <code>CLOSE</code> and <code>DEALLOCATE</code> follow each other because we only use the cursor once.)</p>
<h3 id="advancing-the-cursor">Advancing the cursor<a class="headerlink" href="#advancing-the-cursor" title="Permanent link">¶</a></h3>
<p>The current element of the cursor is accessed by "copying" the values ​​into local variable(s) using the <code>FETCH</code> command. The variables used here must be declared in advance. The <code>FETCH</code> statement typically get the following element (<code>FETCH NEXT</code>), but if the cursor is not <code>FORWARD_ONLY</code>, you can move back and forward too:</p>
<div class="highlight"><pre><span></span><code><span class="k">FETCH</span>
<span class="w">  </span><span class="p">[</span><span class="k">NEXT</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PRIORITY</span><span class="w"> </span><span class="k">FIRST</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">LAST</span>
<span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="k">ABSOLUTE</span><span class="w"> </span><span class="err">{</span><span class="n">n</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">@</span><span class="n">nvar</span><span class="err">}</span>
<span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="k">RELATIVE</span><span class="w"> </span><span class="err">{</span><span class="n">n</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">@</span><span class="n">nvar</span><span class="err">}</span>
<span class="w">  </span><span class="p">]</span>
<span class="k">FROM</span><span class="w"> </span><span class="k">cursor_name</span>
<span class="k">INTO</span><span class="w"> </span><span class="o">@</span><span class="n">variable_name</span><span class="w"> </span><span class="p">[,</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="n">n</span><span class="p">]</span>
</code></pre></div>
<p>We can determine whether the <code>FETCH</code> statement was successful by querying the implicit variable <code>@@FETCH_STATUS</code>. The value of the variable <code>@@FETCH_STATUS</code> is:</p>
<ul>
<li>0 for a successful FETCH,</li>
<li>-1 for a failed FETCH,</li>
<li>-2 if the requested row is missing (when using <code>KEYSET</code>).</li>
</ul>
<p>The complete iteration thus requires <strong>two</strong> <code>FETCH</code> statements and one <code>WHILE</code> loop:</p>
<div class="highlight"><pre><span></span><code><span class="c1">-- declare, open ...</span>
<span class="k">FETCH</span><span class="w"> </span><span class="k">NEXT</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">cur</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="o">@</span><span class="n">var1</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">var2</span>
<span class="n">WHILE</span><span class="w"> </span><span class="o">@@</span><span class="n">FETCH_STATUS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="k">BEGIN</span>
<span class="w">  </span><span class="c1">-- ... custom logic</span>
<span class="w">  </span><span class="k">FETCH</span><span class="w"> </span><span class="k">NEXT</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">cur</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="o">@</span><span class="n">var1</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">var2</span>
<span class="k">END</span>
</code></pre></div>
<p>Note that the <code>FETCH</code> statement appears twice here. This is because the first one outside of the loop is used to query the very first record, and the second one inside the loop retrieves each additional record one at a time.</p>
<h3 id="example">Example<a class="headerlink" href="#example" title="Permanent link">¶</a></h3>
<p>Let us see a complete example. Let us query products that have few items in stock left, and if the last sale was more than a year ago, discount the product price:</p>
<div class="highlight"><pre><span></span><code><span class="c1">-- Extract the data from the cursor into these variables</span>
<span class="k">DECLARE</span><span class="w"> </span><span class="o">@</span><span class="n">ProductName</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="k">max</span><span class="p">)</span>
<span class="k">DECLARE</span><span class="w"> </span><span class="o">@</span><span class="n">ProductID</span><span class="w"> </span><span class="nb">int</span>
<span class="k">DECLARE</span><span class="w"> </span><span class="o">@</span><span class="n">LastOrder</span><span class="w"> </span><span class="n">datetime</span>

<span class="k">DECLARE</span><span class="w"> </span><span class="n">products_cur</span><span class="w"> </span><span class="k">CURSOR</span><span class="w"> </span><span class="k">SCROLL</span><span class="w"> </span><span class="n">SCROLL_LOCKS</span><span class="w"> </span><span class="c1">-- Lock for guaranteed update</span>
<span class="k">FOR</span>
<span class="w">  </span><span class="k">SELECT</span><span class="w"> </span><span class="n">Id</span><span class="p">,</span><span class="w"> </span><span class="n">Name</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">Product</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">Stock</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="c1">-- Cursor query</span>
<span class="k">FOR</span><span class="w"> </span><span class="k">UPDATE</span><span class="w"> </span><span class="k">OF</span><span class="w"> </span><span class="n">Price</span><span class="w"> </span><span class="c1">-- We also want to update the records</span>

<span class="c1">-- Typical opening, fetch, loop</span>
<span class="k">OPEN</span><span class="w"> </span><span class="n">products_cur</span>
<span class="k">FETCH</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">products_cur</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="o">@</span><span class="n">ProductID</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">ProductName</span>
<span class="n">WHILE</span><span class="w"> </span><span class="o">@@</span><span class="n">FETCH_STATUS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="k">BEGIN</span>

<span class="w">  </span><span class="c1">-- We can perform any operation in the cycle</span>
<span class="w">  </span><span class="c1">-- Find the time of the last purchase</span>
<span class="w">  </span><span class="k">SELECT</span><span class="w"> </span><span class="o">@</span><span class="n">LastOrder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">MAX</span><span class="p">([</span><span class="k">Order</span><span class="p">].</span><span class="nb">Date</span><span class="p">)</span>
<span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="p">[</span><span class="k">Order</span><span class="p">]</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">OrderItem</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="p">[</span><span class="k">Order</span><span class="p">].</span><span class="n">Id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">OrderItem</span><span class="p">.</span><span class="n">OrderId</span>
<span class="w">    </span><span class="k">WHERE</span><span class="w"> </span><span class="n">OrderItem</span><span class="p">.</span><span class="n">ProductID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">ProductId</span>

<span class="w">  </span><span class="c1">-- Diagnostic display</span>
<span class="w">  </span><span class="n">PRINT</span><span class="w"> </span><span class="n">CONCAT</span><span class="p">(</span><span class="s1">'ProductID:'</span><span class="p">,</span><span class="w"> </span><span class="k">convert</span><span class="p">(</span><span class="n">nvarchar</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">ProductID</span><span class="p">),</span><span class="w"> </span><span class="s1">'Last order:'</span><span class="p">,</span><span class="w"> </span><span class="k">ISNULL</span><span class="p">(</span><span class="k">convert</span><span class="p">(</span><span class="n">nvarchar</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">LastOrder</span><span class="p">),</span><span class="w"> </span><span class="s1">'No last order'</span><span class="p">))</span>

<span class="w">  </span><span class="k">IF</span><span class="w"> </span><span class="o">@</span><span class="n">LastOrder</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">OR</span><span class="w"> </span><span class="o">@</span><span class="n">LastOrder</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">DATEADD</span><span class="p">(</span><span class="k">year</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">GETDATE</span><span class="p">())</span>
<span class="w">  </span><span class="k">BEGIN</span>
<span class="w">    </span><span class="k">UPDATE</span><span class="w"> </span><span class="n">Product</span>
<span class="w">      </span><span class="k">SET</span><span class="w"> </span><span class="n">Price</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Price</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">75</span>
<span class="w">      </span><span class="k">WHERE</span><span class="w"> </span><span class="k">CURRENT</span><span class="w"> </span><span class="k">OF</span><span class="w"> </span><span class="n">products_cur</span>
<span class="w">      </span><span class="c1">-- Update current cursor record</span>
<span class="w">      </span><span class="c1">-- Alternative: WHERE Id = @ProductID</span>
<span class="w">  </span><span class="k">END</span>

<span class="w">  </span><span class="c1">-- Query next record and then go to the WHILE loop to verify if it was successful</span>
<span class="w">  </span><span class="k">FETCH</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">products_cur</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="o">@</span><span class="n">ProductID</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">ProductName</span>
<span class="k">END</span>
<span class="c1">-- Stop using the cursor</span>
<span class="k">CLOSE</span><span class="w"> </span><span class="n">products_cur</span>
<span class="k">DEALLOCATE</span><span class="w"> </span><span class="n">products_cur</span>
</code></pre></div>
<h2 id="stored-procedures-and-functions">Stored procedures and functions<a class="headerlink" href="#stored-procedures-and-functions" title="Permanent link">¶</a></h2>
<p>The codes written in the previous examples were sent to the server and executed immediately. We can also write code that is stored by the server and can be called at any later time. In a modular programming environment, we usually call these functions, and in an object-oriented world, we call them methods. In Microsoft SQL Server, these are called stored procedures and stored functions. <em>Stored</em> in the name indicates that the procedure code is stored in the database along with the data (and will be included in backups, for example).</p>
<p>The difference between a <em>procedure</em> and a <em>function</em> is that procedures typically have no return value, while functions do. An additional restriction in the MSSQL platform is that functions can only read the database but not make changes.</p>
<h3 id="procedures">Procedures<a class="headerlink" href="#procedures" title="Permanent link">¶</a></h3>
<p>You can create a stored procedure with the following syntax:</p>
<div class="highlight"><pre><span></span><code><span class="k">CREATE</span><span class="w"> </span><span class="p">[</span><span class="k">OR</span><span class="w"> </span><span class="k">ALTER</span><span class="p">]</span><span class="w"> </span><span class="n">PROC</span><span class="p">[</span><span class="n">EDURE</span><span class="p">]</span><span class="w"> </span><span class="n">procedure_name</span>
<span class="w">  </span><span class="p">[</span><span class="err">{</span><span class="o">@</span><span class="w"> </span><span class="k">parameter</span><span class="w"> </span><span class="n">data_type</span><span class="err">}</span><span class="p">]</span><span class="w"> </span><span class="p">[,</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="n">n</span><span class="p">]</span>
<span class="k">AS</span>
<span class="p">[</span><span class="k">BEGIN</span><span class="p">]</span>
<span class="w">  </span><span class="n">sql_instructions</span><span class="w"> </span><span class="p">[...</span><span class="w"> </span><span class="n">n</span><span class="p">]</span>
<span class="p">[</span><span class="k">END</span><span class="p">]</span>
</code></pre></div>
<p>The result of the <code>CREATE OR ALTER</code> statement is the creation of the stored procedure, if it does not exist, or else its update with the new contents. Prior to MSSQL Server 2016, there was no <code>CREATE OR ALTER</code>, only <code>CREATE PROC</code> and <code>ALTER PROC</code>. We can delete a stored procedure with the <code>DROP PROCECURE</code> statement, which removes the procedure from the server.</p>
<p>For example, Let us create a new tax percentage record in the <code>VAT</code> table, guaranteeing that only unique percentages can be added:</p>
<div class="highlight"><pre><span></span><code><span class="k">create</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="k">alter</span><span class="w"> </span><span class="k">procedure</span><span class="w"> </span><span class="n">InsertNewVAT</span><span class="w"> </span><span class="c1">-- create a stored procedure</span>
<span class="w">    </span><span class="o">@</span><span class="n">Percentage</span><span class="w"> </span><span class="nb">int</span><span class="w"> </span><span class="c1">-- stored procedure parameters</span>
<span class="k">as</span>
<span class="w">  </span><span class="k">begin</span>
<span class="w">  </span><span class="c1">-- this is where the code begins, which the system executes when the procedure is called</span>
<span class="w">  </span><span class="k">begin</span><span class="w"> </span><span class="n">tran</span><span class="w"> </span><span class="c1">-- to avoid non-repeatable reading</span>
<span class="w">  </span><span class="k">set</span><span class="w"> </span><span class="k">transaction</span><span class="w"> </span><span class="k">isolation</span><span class="w"> </span><span class="k">level</span><span class="w"> </span><span class="k">repeatable</span><span class="w"> </span><span class="k">read</span>

<span class="w">  </span><span class="k">declare</span><span class="w"> </span><span class="o">@</span><span class="k">Count</span><span class="w"> </span><span class="nb">int</span>

<span class="w">  </span><span class="k">select</span><span class="w"> </span><span class="o">@</span><span class="k">Count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span>
<span class="w">  </span><span class="k">from</span><span class="w"> </span><span class="n">VAT</span>
<span class="w">  </span><span class="k">where</span><span class="w"> </span><span class="n">Percentage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">Percentage</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">@</span><span class="k">Count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">      </span><span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">VAT</span><span class="w"> </span><span class="k">values</span><span class="w"> </span><span class="err">​​</span><span class="p">(</span><span class="o">@</span><span class="n">Percentage</span><span class="p">)</span>
<span class="w">  </span><span class="k">else</span>
<span class="w">      </span><span class="n">print</span><span class="w"> </span><span class="s1">'error'</span><span class="p">;</span>

<span class="k">commit</span>
<span class="k">end</span>
</code></pre></div>
<p>The stored procedure is created by executing the former command, and then it can be called as follows:</p>
<div class="highlight"><pre><span></span><code><span class="k">exec</span><span class="w"> </span><span class="n">InsertNewVAT</span><span class="w"> </span><span class="mi">27</span>
</code></pre></div>
<p>Stored procedures are part of our database. For example, in Microsoft SQL Server Management Studio, it is visible here:</p>
<p><a class="glightbox" data-desc-position="bottom" data-height="auto" data-width="100%" href="../lecture-notes/mssql/img//mssql-stored-proc-in-db.png"><img alt="Stored procedure in database" src="../lecture-notes/mssql/img//mssql-stored-proc-in-db.png"/></a></p>
<h3 id="scalar-functions">Scalar functions<a class="headerlink" href="#scalar-functions" title="Permanent link">¶</a></h3>
<p>The declaration of a function is similar to a procedure, but we must also specify the return type:</p>
<div class="highlight"><pre><span></span><code><span class="k">CREATE</span><span class="w"> </span><span class="p">[</span><span class="k">OR</span><span class="w"> </span><span class="k">ALTER</span><span class="p">]</span><span class="w"> </span><span class="k">FUNCTION</span><span class="w"> </span><span class="n">name</span>
<span class="p">([</span><span class="err">{</span><span class="o">@</span><span class="w"> </span><span class="k">parameter</span><span class="w"> </span><span class="n">data_type</span><span class="err">}</span><span class="p">]</span><span class="w"> </span><span class="p">[,</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="n">n</span><span class="p">])</span>
<span class="k">RETURNS</span><span class="w"> </span><span class="k">data</span><span class="w"> </span><span class="k">type</span>
<span class="p">[</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="p">]</span>
<span class="k">BEGIN</span>
<span class="w">  </span><span class="n">instructions</span>
<span class="w">  </span><span class="k">RETURN</span><span class="w"> </span><span class="n">scalar_value</span>
<span class="k">END</span>
</code></pre></div>
<p>Let us see a function with return value <code>int</code> that has no input parameters:</p>
<div class="highlight"><pre><span></span><code><span class="k">CREATE</span><span class="w"> </span><span class="k">OR</span><span class="w"> </span><span class="k">ALTER</span><span class="w"> </span><span class="k">FUNCTION</span><span class="w"> </span><span class="n">LargestVATPercentage</span><span class="p">()</span>
<span class="k">RETURNS</span><span class="w"> </span><span class="nb">int</span>
<span class="k">BEGIN</span>
<span class="k">RETURN</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="k">MAX</span><span class="p">(</span><span class="n">Percentage</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">VAT</span><span class="p">)</span>
<span class="k">END</span>
</code></pre></div>
<p>Here's how to use this function:</p>
<div class="highlight"><pre><span></span><code><span class="k">select</span><span class="w"> </span><span class="n">dbo</span><span class="p">.</span><span class="n">LargestVATPercentage</span><span class="p">()</span>
<span class="c1">-- The dbo prefix is ​​the name of the schema, indicating that this is not a built-in function</span>
<span class="c1">-- Without this, the function is not found</span>

<span class="c1">-- or for example</span>
<span class="k">DECLARE</span><span class="w"> </span><span class="o">@</span><span class="n">maxvat</span><span class="w"> </span><span class="nb">int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dbo</span><span class="p">.</span><span class="n">LargestVATPercentage</span><span class="p">()</span>
<span class="k">select</span><span class="w"> </span><span class="o">@</span><span class="n">maxvat</span>
</code></pre></div>
<h3 id="table-functions">Table functions<a class="headerlink" href="#table-functions" title="Permanent link">¶</a></h3>
<p>A function can also yield a table as the result. In this case, the declaration looks like this:</p>
<div class="highlight"><pre><span></span><code><span class="k">CREATE</span><span class="w"> </span><span class="p">[</span><span class="k">OR</span><span class="w"> </span><span class="k">ALTER</span><span class="p">]</span><span class="w"> </span><span class="k">FUNCTION</span><span class="w"> </span><span class="n">name</span>
<span class="p">([</span><span class="err">{</span><span class="o">@</span><span class="w"> </span><span class="k">parameter</span><span class="w"> </span><span class="k">data</span><span class="w"> </span><span class="k">type</span><span class="err">}</span><span class="p">]</span><span class="w"> </span><span class="p">[,</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="n">n</span><span class="p">])</span>
<span class="k">RETURNS</span><span class="w"> </span><span class="k">TABLE</span>
<span class="p">[</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="p">]</span>
<span class="k">RETURN</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="k">statement</span>
</code></pre></div>
<p>For example, consider retrieving VAT rates above a certain percentage:</p>
<div class="highlight"><pre><span></span><code><span class="k">CREATE</span><span class="w"> </span><span class="k">FUNCTION</span><span class="w"> </span><span class="n">VATPercentages</span><span class="p">(</span><span class="o">@</span><span class="k">min</span><span class="w"> </span><span class="nb">int</span><span class="p">)</span>
<span class="k">RETURNS</span><span class="w"> </span><span class="k">TABLE</span>
<span class="k">AS</span><span class="w"> </span><span class="k">RETURN</span>
<span class="p">(</span>
<span class="w">    </span><span class="k">SELECT</span><span class="w"> </span><span class="n">ID</span><span class="p">,</span><span class="w"> </span><span class="n">Percentage</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">VAT</span>
<span class="w">    </span><span class="k">WHERE</span><span class="w"> </span><span class="n">Percentage</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="o">@</span><span class="k">min</span>
<span class="p">)</span>
</code></pre></div>
<p>This function returns a table, so you can use the function anywhere a table can appear, for example:</p>
<div class="highlight"><pre><span></span><code><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">VATPercentages</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
</code></pre></div>
<p>Since the function returns a table, we can even <code>join</code> it:</p>
<div class="highlight"><pre><span></span><code><span class="k">SELECT</span><span class="w"> </span><span class="n">VAT</span><span class="p">.</span><span class="n">Percentage</span><span class="p">,</span><span class="w"> </span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">VAT</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">VATPercentages</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">VAT</span><span class="p">.</span><span class="n">ID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">Id</span>
<span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">VAT</span><span class="p">.</span><span class="n">Percentage</span>
</code></pre></div>
<h2 id="error-handling">Error handling<a class="headerlink" href="#error-handling" title="Permanent link">¶</a></h2>
<p>In the stored procedure example, we wanted to prevent duplicate records from being inserted into a table. This was accomplished above by not executing the instruction. However, it would be more appropriate to report the error to the caller. This is what structured error handling is about. In case of an error, you can use the <code>throw</code> command to raise an error. This command interrupts code execution and returns control to the caller (where the error can be handled or passed on). The error has a number (between 50000 and 2147483647), a text, and an error status identifier between 0-255.</p>
<p>The updated procedure for recording the VAT key looks like this:</p>
<div class="highlight"><pre><span></span><code><span class="k">create</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="k">alter</span><span class="w"> </span><span class="k">procedure</span><span class="w"> </span><span class="n">InsertNewVAT</span>
<span class="w">    </span><span class="o">@</span><span class="n">Percentage</span><span class="w"> </span><span class="nb">int</span>
<span class="k">as</span>
<span class="k">begin</span>

<span class="w">  </span><span class="k">begin</span><span class="w"> </span><span class="n">tran</span>
<span class="w">  </span><span class="k">set</span><span class="w"> </span><span class="k">transaction</span><span class="w"> </span><span class="k">isolation</span><span class="w"> </span><span class="k">level</span><span class="w"> </span><span class="k">repeatable</span><span class="w"> </span><span class="k">read</span>

<span class="w">  </span><span class="k">declare</span><span class="w"> </span><span class="o">@</span><span class="k">Count</span><span class="w"> </span><span class="nb">int</span>

<span class="w">  </span><span class="k">select</span><span class="w"> </span><span class="o">@</span><span class="k">Count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span>
<span class="w">  </span><span class="k">from</span><span class="w"> </span><span class="n">VAT</span>
<span class="w">  </span><span class="k">where</span><span class="w"> </span><span class="n">Percentage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">Percentage</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">@</span><span class="k">Count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">      </span><span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">VAT</span><span class="w"> </span><span class="k">values</span><span class="w"> </span><span class="err">​​</span><span class="p">(</span><span class="o">@</span><span class="n">Percentage</span><span class="p">)</span>
<span class="w">  </span><span class="k">else</span>
<span class="hll"><span class="w">      </span><span class="n">throw</span><span class="w"> </span><span class="mi">51000</span><span class="p">,</span><span class="w"> </span><span class="s1">'error'</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
</span>
<span class="w">  </span><span class="k">commit</span>
<span class="k">end</span>
</code></pre></div>
<p>To handle (catch) an error, you can use the following syntax:</p>
<div class="highlight"><pre><span></span><code><span class="k">begin</span><span class="w"> </span><span class="n">try</span>
<span class="w">  </span><span class="k">exec</span><span class="w"> </span><span class="n">InsertNewVAT</span><span class="w"> </span><span class="mi">27</span>
<span class="k">end</span><span class="w"> </span><span class="n">try</span>
<span class="k">begin</span><span class="w"> </span><span class="n">catch</span>
<span class="w">  </span><span class="c1">-- access the error details with the following functions (similar to stack trace in other languages)</span>
<span class="w">  </span><span class="k">SELECT</span>
<span class="w">    </span><span class="n">ERROR_NUMBER</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">ErrorNumber</span><span class="p">,</span>
<span class="w">    </span><span class="n">ERROR_SEVERITY</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">ErrorSeverity</span><span class="p">,</span>
<span class="w">    </span><span class="n">ERROR_STATE</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">ErrorState</span><span class="p">,</span>
<span class="w">    </span><span class="n">ERROR_PROCEDURE</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">ErrorProcedure</span><span class="p">,</span>
<span class="w">    </span><span class="n">ERROR_LINE</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">ErrorLine</span><span class="p">,</span>
<span class="w">    </span><span class="n">ERROR_MESSAGE</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">ErrorMessage</span><span class="p">;</span>
<span class="k">end</span><span class="w"> </span><span class="n">catch</span>
</code></pre></div>
<p>Of course, it's not just user code that can throw errors. The system also signals errors identically, and we can handle them using the same tools.</p>
<h2 id="triggers">Triggers<a class="headerlink" href="#triggers" title="Permanent link">¶</a></h2>
<p>The tools and language elements described so far have similar counterparts in other platforms. However, triggers are unique to databases. Triggers are event-handling stored procedures. We can subscribe to various events in the database, and when the event occurs, the system will execute our code defined in the trigger.</p>
<p>We will only discuss DML triggers. These are triggers that run due to data modification (<code>insert</code>, <code>update</code>, <code>delete</code>) operations. There are other triggers as well; e.g., you can create triggers for system events. Check the <a href="https://docs.microsoft.com/en-us/sql/t-sql/statements/create-trigger-transact-sql">official documentation</a> for more details.</p>
<h3 id="dml-triggers">DML triggers<a class="headerlink" href="#dml-triggers" title="Permanent link">¶</a></h3>
<p>Using triggers, we can solve several tasks that would be difficult otherwise. Consider, for example, an <strong>audit logging</strong> requirement: when a change is made to a particular table, let us record a log entry. We could solve this task in C#/Java/Python by creating a class or methods for accessing the database table in question. However, nothing prevents the programmer from "bypassing" this logic and accessing the database directly. We cannot prevent this with triggers, but we can create a trigger that performs the required logging instead of the C#/Java/Python code.</p>
<p>Let us look at this example: logging the deletion of any products in a dedicated table:</p>
<div class="highlight"><pre><span></span><code><span class="c1">-- Create the auditing table</span>
<span class="k">create</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">AuditLog</span><span class="p">([</span><span class="n">Description</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="n">nvarchar</span><span class="p">](</span><span class="k">max</span><span class="p">)</span><span class="w"> </span><span class="k">NULL</span><span class="p">)</span>
<span class="k">go</span>

<span class="c1">-- Logging trigger</span>
<span class="k">create</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="k">alter</span><span class="w"> </span><span class="k">trigger</span><span class="w"> </span><span class="n">ProductDeleteLog</span>
<span class="w">  </span><span class="k">on</span><span class="w"> </span><span class="n">Product</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="k">delete</span>
<span class="k">as</span>
<span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">AuditLog</span><span class="w"> </span><span class="p">(</span><span class="n">Description</span><span class="p">)</span>
<span class="k">select</span><span class="w"> </span><span class="s1">'Product deleted: '</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">convert</span><span class="p">(</span><span class="n">nvarchar</span><span class="p">,</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">Name</span><span class="p">)</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">deleted</span><span class="w"> </span><span class="n">d</span>
</code></pre></div>
<p>Executing the commands above creates a trigger in the database (just as a stored procedure is created). This trigger is then executed automatically. So the trigger is not called by us but by the system. Nevertheless, we give the trigger a name to reference it (e.g., if we want to delete it with the <code>DROP TRIGGER</code> statement). The trigger is linked to the table in the database:</p>
<p><a class="glightbox" data-desc-position="bottom" data-height="auto" data-width="100%" href="../lecture-notes/mssql/img//mssql-trigger-in-db.png"><img alt="Trigger in the database" src="../lecture-notes/mssql/img//mssql-trigger-in-db.png"/></a></p>
<p>The syntax for defining a DML trigger is as follows:</p>
<div class="highlight"><pre><span></span><code><span class="k">CREATE</span><span class="w"> </span><span class="k">TRIGGER</span><span class="w"> </span><span class="k">trigger_name</span>
<span class="k">ON</span><span class="w"> </span><span class="err">{</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">view</span><span class="w"> </span><span class="err">}</span>
<span class="w"> </span><span class="k">FOR</span><span class="w"> </span><span class="err">{</span><span class="p">[</span><span class="k">DELETE</span><span class="p">]</span><span class="w"> </span><span class="p">[,]</span><span class="w"> </span><span class="p">[</span><span class="k">INSERT</span><span class="p">]</span><span class="w"> </span><span class="p">[,]</span><span class="w"> </span><span class="p">[</span><span class="k">UPDATE</span><span class="p">]</span><span class="err">}</span>
<span class="k">AS</span>
<span class="n">sql_instruction</span><span class="w"> </span><span class="p">[...</span><span class="w"> </span><span class="n">n</span><span class="p">]</span>
</code></pre></div>
<p>Note that in the trigger definition, we specify the table or view. So a trigger listens for events of a single table. The events are set by listing the requested modifying operations (e.g., <code>for update, insert</code>). Note that three possible options cover all types of changes; also note, that there is no <code>select</code> event — since it is not a change.</p>
<p>The instructions defined in the trigger code are executed <em>after</em> the specified events occur. This means that the changes are already performed (for example, new rows are already inserted into the table), but the transaction of the operation is not yet finished. Thus, we can make further changes as part of the same transaction (and consequently, seeing the result of the "original" command and the trigger as an atomic change) or even aborting the transaction. A particular use case for triggers is to check the consistency of data (that cannot be verified otherwise) and to abort the modification in the event of a violation. We will see an example of this soon.</p>
<p>Triggers are executed per <em>instruction</em>, which means they are called once per DML operation. In other words, the trigger does not handle the changes per row; instead, all changes caused by a single operation are handled at once. So, for example, if an <code>update</code> statement changes 15 rows, the trigger is called once, and we will see all 15 changes. Of course, this is also true for inserting and deleting - a deletion operation can delete multiple rows, and we can insert multiple records with a single insert command.</p>
<div class="admonition warning">
<p class="admonition-title">There is no row-level trigger</p>
<p>Other database platforms have row-level triggers, where the trigger is called individually for all the modified rows. Microsoft SQL Server platform does not have such a trigger!</p>
</div>
<p>How do we know what changes are handled in the trigger? Inside the trigger, we have access to two log tables through the implicit variables <code>inserted</code> and <code>deleted</code>. The structure of these tables is identical to the table on which the trigger is defined. These tables exist only during the trigger execution and can only be accessed from within the trigger. Their content depends on the type of operation that invoked the trigger:</p>
<table>
<thead>
<tr>
<th></th>
<th>insert</th>
<th>delete</th>
<th>update</th>
</tr>
</thead>
<tbody>
<tr>
<td>inserted</td>
<td>new records</td>
<td>empty</td>
<td>new values of records</td>
</tr>
<tr>
<td>deleted</td>
<td>empty</td>
<td>deleted records</td>
<td>old values ​​of records</td>
</tr>
</tbody>
</table>
<p>When inserting, the inserted records can be found in the database table (but there, we do not "see" that they have been newly inserted), and they are also available in the <code>inserted</code> table. In the case of deletion, <code>deleted</code> contains the rows already deleted from the table. Finally, in the case of <code>update</code>, we see the states before and after the change in the two log tables. We need to work with these log tables as tables; we should always expect to have more than one record in them.</p>
<div class="admonition warning">
<p class="admonition-title">The <code>inserted</code> and <code>deleted</code> are tables</p>
<p>The <code>inserted</code> and <code>deleted</code> tables can only be treated as tables! For example, it does not make sense to use <code>select @id=inserted.ID</code>; instead, we can use a cursor on these tables or <code>join</code> them.</p>
</div>
<p>We have already seen an example of audit logging implemented with a trigger. Let us look at other use-cases. Let us have a table with an email address column. When inserting and modifying, we need to check the email address value, and we must not accept text that does not look like an email address. Here <strong>we validate a rule of consistency</strong> with the trigger.</p>
<div class="highlight"><pre><span></span><code><span class="c1">-- Create a function to check the email address</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">FUNCTION</span><span class="w"> </span><span class="p">[</span><span class="n">IsEmailValid</span><span class="p">](</span><span class="o">@</span><span class="w"> </span><span class="n">email</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="mi">1000</span><span class="p">))</span>
<span class="k">RETURNS</span><span class="w"> </span><span class="nb">bit</span><span class="w"> </span><span class="c1">-- true / false return value</span>
<span class="k">AS</span>
<span class="k">BEGIN</span>
<span class="w">  </span><span class="k">IF</span><span class="w"> </span><span class="o">@</span><span class="n">email</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="k">null</span><span class="w"> </span><span class="k">RETURN</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="c1">-- Cannot be null</span>
<span class="w">  </span><span class="k">IF</span><span class="w"> </span><span class="o">@</span><span class="n">email</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">''</span><span class="w"> </span><span class="k">RETURN</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="c1">-- Cannot be an empty string</span>
<span class="w">  </span><span class="k">IF</span><span class="w"> </span><span class="o">@</span><span class="n">email</span><span class="w"> </span><span class="k">LIKE</span><span class="w"> </span><span class="s1">'%_@%_._%'</span><span class="w"> </span><span class="k">RETURN</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="c1">-- Looks like an email</span>
<span class="w">  </span><span class="k">RETURN</span><span class="w"> </span><span class="mi">0</span>
<span class="w">  </span><span class="c1">-- The same in one line:</span>
<span class="w">  </span><span class="c1">-- RETURN CASE WHEN ISNULL(@email, '') &lt;&gt; '' AND @email LIKE '%_@%_._%' THEN 1 ELSE 0 END</span>
<span class="k">END</span>

<span class="c1">-- The trigger</span>
<span class="k">create</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="k">alter</span><span class="w"> </span><span class="k">trigger</span><span class="w"> </span><span class="n">CustomerEmailSyntaxCheck</span>
<span class="w">  </span><span class="k">on</span><span class="w"> </span><span class="n">Customer</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="k">insert</span><span class="p">,</span><span class="w"> </span><span class="k">update</span><span class="w"> </span><span class="c1">-- Check both inserting and modifying</span>
<span class="k">as</span>
<span class="c1">-- For both insertion and modification, the new data is in the inserted table</span>
<span class="c1">-- Is there an item there for which the new email address is not valid?</span>
<span class="k">if</span><span class="w"> </span><span class="k">exists</span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">inserted</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">dbo</span><span class="p">.</span><span class="n">IsEmailValid</span><span class="p">(</span><span class="n">i</span><span class="p">.</span><span class="n">Email</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">  </span><span class="n">throw</span><span class="w"> </span><span class="mi">51234</span><span class="p">,</span><span class="w"> </span><span class="s1">'invalid email address'</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="c1">-- abort the transaction by raising the error</span>
</code></pre></div>
<p>The above trigger runs after insertion or modification in the same transaction. So if we throw an error, the transaction will be aborted (unless handled by the caller). By running the trigger at the instruction level, a single faulty record interrupts the entire operation. Of course, this is what we expect due to atomicity: the indivisibility of the transaction is satisfied for the instruction as a whole, i.e., for inserting/modifying several records at once.</p>
<p>Another common use of triggers is <strong>maintenance of denormalized data</strong>. Although we try to avoid denormalization in a relational database, in practice, it may be necessary to store computed data for performance reasons. Let us look at an example of this as well. Suppose customers have two email addresses: one to sign in with, an optional second one to use for notifications. To avoid always having to query both email addresses and choosing between the two, let us make sure the <em>effective</em> email address is available in the database "calculated" from the previous two:</p>
<div class="highlight"><pre><span></span><code><span class="c1">-- Additional email address columns for customers</span>
<span class="k">alter</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">Customer</span>
<span class="k">add</span><span class="w"> </span><span class="p">[</span><span class="n">NotificationEmail</span><span class="p">]</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="k">max</span><span class="p">),</span><span class="w"> </span><span class="p">[</span><span class="n">EffectiveEmail</span><span class="p">]</span><span class="w"> </span><span class="n">nvarchar</span><span class="p">(</span><span class="k">max</span><span class="p">)</span>
<span class="k">go</span>

<span class="c1">-- Trigger to update the effective email address</span>
<span class="k">create</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="k">alter</span><span class="w"> </span><span class="k">trigger</span><span class="w"> </span><span class="n">CustomerEmailUpdate</span>
<span class="w">  </span><span class="k">on</span><span class="w"> </span><span class="n">Customer</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="k">insert</span><span class="p">,</span><span class="w"> </span><span class="k">update</span>
<span class="k">as</span>
<span class="k">update</span><span class="w"> </span><span class="n">Customer</span><span class="w"> </span><span class="c1">-- We modify the Customer table, not the inserted implicit table</span>
<span class="k">set</span><span class="w"> </span><span class="n">EffectiveEmail</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">ISNULL</span><span class="p">(</span><span class="n">i</span><span class="p">.</span><span class="n">NotificationEmail</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">.</span><span class="n">Email</span><span class="p">)</span><span class="w"> </span><span class="c1">-- Copy one or the other value to the EffectiveEmail column</span>
<span class="k">from</span><span class="w"> </span><span class="n">Customer</span><span class="w"> </span><span class="k">c</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="n">inserted</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">ID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="p">.</span><span class="n">ID</span><span class="w"> </span><span class="c1">-- Records must be retrieved from the Customer table based on the inserted rows</span>
</code></pre></div>
<div class="admonition important">
<p class="admonition-title">Trigger recursion</p>
<p>Note that in this trigger, an update is executed in response to an update event. This is a recursion. Recursion of DML triggers is disabled by default, so the above example does not invoke trigger recursion. However, if trigger recursion were enabled in the database, we would need to handle it.</p>
</div>
<p>Let us look at another example of denormalized data maintenance. In the order table, let us add a grand total column, which is the total net price of the order. We need a trigger to keep the value updated automatically:</p>
<div class="highlight"><pre><span></span><code><span class="k">create</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="k">alter</span><span class="w"> </span><span class="k">trigger</span><span class="w"> </span><span class="n">OrderTotalUpdateTrigger</span>
<span class="w">  </span><span class="k">on</span><span class="w"> </span><span class="n">OrderItem</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="k">insert</span><span class="p">,</span><span class="w"> </span><span class="k">update</span><span class="p">,</span><span class="w"> </span><span class="k">delete</span>
<span class="k">as</span>

<span class="k">update</span><span class="w"> </span><span class="k">Order</span>
<span class="k">set</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">isnull</span><span class="p">(</span><span class="n">Total</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">TotalChange</span>
<span class="k">from</span><span class="w"> </span><span class="k">Order</span><span class="w"> </span><span class="k">inner</span><span class="w"> </span><span class="k">join</span>
<span class="w">        </span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="n">i</span><span class="p">.</span><span class="n">OrderID</span><span class="p">,</span><span class="w"> </span><span class="k">sum</span><span class="p">(</span><span class="n">Amount</span><span class="o">*</span><span class="n">Price</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">TotalChange</span>
<span class="w">        </span><span class="k">from</span><span class="w"> </span><span class="n">inserted</span><span class="w"> </span><span class="n">i</span>
<span class="w">        </span><span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">i</span><span class="p">.</span><span class="n">OrderID</span><span class="p">)</span><span class="w"> </span><span class="n">OrderChange</span>
<span class="w">    </span><span class="k">on</span><span class="w"> </span><span class="k">Order</span><span class="p">.</span><span class="n">ID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">OrderChange</span><span class="p">.</span><span class="n">OrderID</span>

<span class="k">update</span><span class="w"> </span><span class="k">Order</span>
<span class="k">set</span><span class="w"> </span><span class="n">Total</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">isnull</span><span class="p">(</span><span class="n">Total</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="err">–</span><span class="w"> </span><span class="n">TotalChange</span>
<span class="k">from</span><span class="w"> </span><span class="k">Order</span><span class="w"> </span><span class="k">inner</span><span class="w"> </span><span class="k">join</span>
<span class="w">        </span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">OrderID</span><span class="p">,</span><span class="w"> </span><span class="k">sum</span><span class="p">(</span><span class="n">Amount</span><span class="o">*</span><span class="n">Price</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">TotalChange</span>
<span class="w">        </span><span class="k">from</span><span class="w"> </span><span class="n">deleted</span><span class="w"> </span><span class="n">d</span>
<span class="w">        </span><span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">OrderID</span><span class="p">)</span><span class="w"> </span><span class="n">OrderChange</span>
<span class="w">    </span><span class="k">on</span><span class="w"> </span><span class="k">Order</span><span class="p">.</span><span class="n">ID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">OrderChange</span><span class="p">.</span><span class="n">OrderID</span>
</code></pre></div>
<p>In this trigger, it is worth noting that while the event occurs in the <code>OrderItem</code> table, the content to be updated is in the <code>Order</code> table. This is fine, a trigger can read and write any part of the database, and all changes are executed in the same transaction. Furthermore, we do not recalculate the total amount in the trigger but alter it in response to the changes. Although this makes the trigger code more complex, it is more effective this way.</p>
<div class="admonition note">
<p class="admonition-title">Sequence of triggers</p>
<p>We can define multiple triggers for an event. But the order of their execution cannot be specified. We can set the first and last triggers, but we cannot make assumptions regarding their sequence otherwise - it is considered ill-advised to design functionality where triggers need to build on each other.</p>
</div>
<h3 id="instead-of-triggers"><em>Instead of</em> triggers<a class="headerlink" href="#instead-of-triggers" title="Permanent link">¶</a></h3>
<p>A special type of trigger is the so-called <em>instead of trigger</em>. Such triggers can be defined for both tables and views. Let us look at using them on tables first. An <em>instead of</em> trigger defined on a table, as its name suggests, runs the instruction we define in the trigger instead of the actual operation's <code>insert / update / delete</code>. E.g., when inserting, the new rows are not added to the table, and when deleting, rows are not deleted. Instead, we can define in the trigger how to perform these operations. In the overridden process, we can access the table itself and execute the necessary actions in this table. These operations do not cause recursion in the trigger. These triggers can be considered as <em>before</em> triggers, i.e., we can perform checks before making the changes and abort the operation in case of an error.</p>
<p>A typical use case for an <em>instead of</em> trigger is, for example, when we do not want to perform a deletion. This is also called <em>soft delete</em>:,instead of deleting, we only mark the records as deleted:</p>
<div class="highlight"><pre><span></span><code><span class="c1">-- Soft delete flag column in the table with a default value of 0 (i.e., false)</span>
<span class="k">alter</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">Product</span>
<span class="k">add</span><span class="w"> </span><span class="p">[</span><span class="n">IsDeleted</span><span class="p">]</span><span class="w"> </span><span class="nb">bit</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">CONSTRAINT</span><span class="w"> </span><span class="n">DF_Product_IsDeleted</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="mi">0</span>
<span class="k">go</span>

<span class="c1">-- Instead of trigger, the delete command does not perform the deletion</span>
<span class="c1">-- the following code runs instead</span>
<span class="k">create</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="k">alter</span><span class="w"> </span><span class="k">trigger</span><span class="w"> </span><span class="n">ProductSoftDelete</span>
<span class="w">  </span><span class="k">on</span><span class="w"> </span><span class="n">Product</span>
<span class="w">  </span><span class="k">instead</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="k">delete</span>
<span class="k">as</span>
<span class="k">update</span><span class="w"> </span><span class="n">Product</span>
<span class="w">  </span><span class="k">set</span><span class="w"> </span><span class="n">IsDeleted</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span>
<span class="w">  </span><span class="k">where</span><span class="w"> </span><span class="n">ID</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="n">ID</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">deleted</span><span class="p">)</span>
</code></pre></div>
<p>Another typical use case for <em>instead of</em> triggers is views. A view is the result of a query, so inserting new data into the view does not make sense. However, you can use an <em>instead of</em> trigger to define what to do instead of "inserting into view." Let us look at an example. In the view below, we combine data from the product and VAT tables so that the VAT percentage is displayed in the view instead of the ID of the referenced VAT record. We can insert into this view by inserting the data into the product table instead:</p>
<div class="highlight"><pre><span></span><code><span class="c1">-- Define the view</span>
<span class="k">create</span><span class="w"> </span><span class="k">view</span><span class="w"> </span><span class="n">ProductWithVatPercentage</span>
<span class="k">as</span>
<span class="k">select</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">Id</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">Name</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">Price</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">Stock</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">.</span><span class="n">Percentage</span>
<span class="k">from</span><span class="w"> </span><span class="n">Product</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="n">Vat</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">VATID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">v</span><span class="p">.</span><span class="n">Id</span>

<span class="c1">-- Instead of trigger for the view</span>
<span class="k">create</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="k">alter</span><span class="w"> </span><span class="k">trigger</span><span class="w"> </span><span class="n">ProductWithVatPercentageInsert</span>
<span class="k">on</span><span class="w"> </span><span class="n">ProductWithVatPercentage</span>
<span class="k">instead</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="k">insert</span>
<span class="k">as</span>
<span class="w">  </span><span class="c1">-- The insertion goes into the Product table: a new row is created for each inserted record</span>
<span class="w">  </span><span class="c1">-- And we find the VAT record corresponding to the provided percentage</span>
<span class="w">  </span><span class="c1">-- The solution is not complete because it does not handle if there is no matching VAT record</span>
<span class="w">  </span><span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">Product</span><span class="p">(</span><span class="n">Name</span><span class="p">,</span><span class="w"> </span><span class="n">Price</span><span class="p">,</span><span class="w"> </span><span class="n">Stock</span><span class="p">,</span><span class="w"> </span><span class="n">VATID</span><span class="p">,</span><span class="w"> </span><span class="n">CategoryID</span><span class="p">)</span>
<span class="w">  </span><span class="k">select</span><span class="w"> </span><span class="n">i</span><span class="p">.</span><span class="n">Name</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">.</span><span class="n">Price</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">.</span><span class="n">Stock</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">.</span><span class="n">ID</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span>
<span class="w">    </span><span class="k">from</span><span class="w"> </span><span class="n">inserted</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="n">VAT</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">v</span><span class="p">.</span><span class="n">Percentage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="p">.</span><span class="n">Percentage</span>

<span class="c1">-- The trigger can be tested by inserting data into the view</span>
<span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">ProductWithVatPercentage</span><span class="p">(</span><span class="n">Name</span><span class="p">,</span><span class="w"> </span><span class="n">Price</span><span class="p">,</span><span class="w"> </span><span class="n">Stock</span><span class="p">,</span><span class="w"> </span><span class="n">Percentage</span><span class="p">)</span>
<span class="k">values</span><span class="w"> </span><span class="p">(</span><span class="s1">'Red ball'</span><span class="p">,</span><span class="w"> </span><span class="mi">1234</span><span class="p">,</span><span class="w"> </span><span class="mi">22</span><span class="p">,</span><span class="w"> </span><span class="mi">27</span><span class="p">)</span>
</code></pre></div>
<hr/>
<div class="md-source-file">
<span class="md-source-file__fact"> <span class="md-icon" title="Last update"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
<path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1-2.1-2M12.5 7v5.2l4 2.4-1 1L11 13V7h1.5M11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2v1.8Z">
</path>
</svg>
</span>
<span title="March 3, 2023 13:36:18">
<span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-timeago"><span class="timeago" datetime="2023-03-03T13:36:18+01:00" locale="en"></span></span><span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-iso_date">2023-03-03</span>
</span>
</span>
<span class="md-source-file__fact">
<span class="md-icon" title="Created"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
<path d="M14.47 15.08 11 13V7h1.5v5.25l3.08 1.83c-.41.28-.79.62-1.11 1m-1.39 4.84c-.36.05-.71.08-1.08.08-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8c0 .37-.03.72-.08 1.08.69.1 1.33.32 1.92.64.1-.56.16-1.13.16-1.72 0-5.5-4.5-10-10-10S2 6.5 2 12s4.47 10 10 10c.59 0 1.16-.06 1.72-.16-.32-.59-.54-1.23-.64-1.92M18 15v3h-3v2h3v3h2v-3h3v-2h-3v-3h-2Z">
</path>
</svg>
</span>
<span title="January 13, 2020 16:45:07">
<span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-timeago"><span class="timeago" datetime="2020-01-13T16:45:07+01:00" locale="en"></span></span><span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-iso_date">2020-01-13</span>
</span>
</span>
<span class="md-source-file__fact">
<span class="md-icon" title="Szerzők">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
<path d="M12 2A10 10 0 0 0 2 12c0 4.42 2.87 8.17 6.84 9.5.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34-.46-1.16-1.11-1.47-1.11-1.47-.91-.62.07-.6.07-.6 1 .07 1.53 1.03 1.53 1.03.87 1.52 2.34 1.07 2.91.83.09-.65.35-1.09.63-1.34-2.22-.25-4.55-1.11-4.55-4.92 0-1.11.38-2 1.03-2.71-.1-.25-.45-1.29.1-2.64 0 0 .84-.27 2.75 1.02.79-.22 1.65-.33 2.5-.33.85 0 1.71.11 2.5.33 1.91-1.29 2.75-1.02 2.75-1.02.55 1.35.2 2.39.1 2.64.65.71 1.03 1.6 1.03 2.71 0 3.82-2.34 4.66-4.57 4.91.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0 0 12 2Z">
</path>
</svg>
</span>
<span>Contributors</span>
<nav><a class="md-author" href="https://github.com/akosdudas" rel="noopener noreferrer" target="_blank" title="@akosdudas">
<img alt="@akosdudas" src="https://avatars.githubusercontent.com/u/11335181?size=72"/>
</a><a class="md-author" href="https://github.com/tibitoth" rel="noopener noreferrer" target="_blank" title="@tibitoth">
<img alt="@tibitoth" src="https://avatars.githubusercontent.com/u/8333960?size=72"/>
</a></nav>
</span>
</div>
</article>
</div>
</div>
<a class="md-top md-icon" data-md-component="top" hidden="" href="#">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"></path></svg>
            Back to top
          </a>
</main>
<footer class="md-footer">
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-copyright">
<div class="md-copyright__highlight">
      Copyright © BME VIK AUT
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank">
      Material for MkDocs
    </a>
</div>
</div>
</div>
</footer>
</div>
<div class="md-dialog" data-md-component="dialog">
<div class="md-dialog__inner md-typeset"></div>
</div>
<script id="__config" type="application/json">{"base": "../../..", "features": ["navigation.tabs", "navigation.instant", "navigation.top", "search.suggest", "content.action.edit"], "search": "../../../assets/javascripts/workers/search.db81ec45.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
<script src="../../../assets/javascripts/bundle.a00a7c5e.min.js"></script>
<script src="../../../js/timeago.min.js"></script>
<script src="../../../js/timeago_mkdocs_material.js"></script>
<script>document$.subscribe(() => {const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});})</script></body>
</html>